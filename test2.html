<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Law Enforcement Deployment Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background: #f0f2f5; }
    #container { display:flex; height:100vh; }
    #sidebar {
      width: 40%; max-width: 500px; background:#fff; border-right:1px solid #ccc;
      overflow-y:auto; padding:15px; box-shadow:2px 0 6px rgba(0,0,0,0.1);
    }
    #map { flex:1; }
    h2 { margin:0 0 10px 0; font-size:18px; color:#333; }
    label { font-size:13px; font-weight:bold; display:block; margin-top:10px; }
    select {
      width:100%; padding:6px; margin-top:4px; border:1px solid #ccc;
      border-radius:4px; font-size:13px;
    }
    table { width:100%; border-collapse:collapse; margin-top:15px; font-size:12px; }
    thead {
      background:#007bff; color:white; position:sticky; top:0; z-index:1;
    }
    th, td { border:1px solid #ddd; padding:6px; text-align:left; }
    tr:nth-child(even) { background:#f9f9f9; }
    tr:hover { background:#f1f7ff; cursor:pointer; }
    tr.dimmed { opacity:0.5; }
    tr.highlighted { background:#ffeeba !important; font-weight:bold; }
    td.personnel span {
      cursor:pointer; color:#007bff; text-decoration:underline;
      display:inline-block; margin:2px 0;
    }
    td.personnel span:hover { color:#0056b3; }
    td img { border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
    .loading {
      display:none; position:absolute; top:10px; left:50%;
      transform:translateX(-50%); background:#fff; padding:6px 12px;
      border:1px solid #ccc; font-size:13px; border-radius:4px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .leaflet-marker-icon.dimmed { opacity:0.5 !important; }
    .leaflet-marker-icon.highlighted {
      filter: drop-shadow(0 0 5px gold);
      z-index:1000 !important;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <h2>Deployment Data</h2>
    <div id="loading" class="loading">Loading...</div>

    <label for="stationFilter">Filter by Station:</label>
    <select id="stationFilter"><option value="">All</option></select>

    <label for="shiftFilter">Filter by Shift:</label>
    <select id="shiftFilter"><option value="">All</option></select>

    <label for="typeFilter">Filter by Deployment Type:</label>
    <select id="typeFilter"><option value="">All</option></select>

    <table id="dataTable">
      <thead>
        <tr>
          <th>Station</th>
          <th>Shift</th>
          <th>Type</th>
          <th>Call Sign</th>
          <th>Personnel</th>
          <th>Comm</th>
          <th>Location</th>
          <th>Photo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="map"></div>
</div>

<script>
const baseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLRdvUF4Q7leQXDAZ6fG-e9RTBBqy9eutZ6V70RJLpV6_ForYuRKgfQ24KJVy7MqZkiqn9sRbLTYtL/pub?output=csv";

let map, markers = [], allData = [];
let selectedIdx = null; // track highlighted row/marker

function showLoading(){ document.getElementById("loading").style.display="block"; }
function hideLoading(){ document.getElementById("loading").style.display="none"; }

function initMap(){
  map = L.map("map").setView([12, 122], 6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:"&copy; OpenStreetMap contributors"
  }).addTo(map);
}

function loadData(){
  showLoading();
  const sheetUrl = baseUrl + "&t=" + new Date().getTime();
  Papa.parse(sheetUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:res=>{
      allData = res.data.map(r=>{
        let lat=null, lng=null;
        if(r["Lat_Long"]){
          const parts = r["Lat_Long"].split(/[, ]+/);
          if(parts.length>=2){ lat=parseFloat(parts[0]); lng=parseFloat(parts[1]); }
        }
        let rawPersonnel = (r["Personnel (Rank_FName_MI_LName)"] || "")
          .split(/[,;\n]+/).map(p=>p.trim()).filter(p=>p);
        let personnelList = rawPersonnel.map(p=>{
          const match = p.match(/^(.*?)\s*\((\d+)\)$/);
          if(match){ return {name:match[1].trim(), mobile:match[2]}; }
          return {name:p, mobile:""};
        });
        return {
          Station:r["Station"], Shift:r["Shift"], DeploymentType:r["Deployment Type"],
          CallSign:r["Call Sign"], Communication:r["Communication Capability"],
          Location:r["Location"], Photo:r["Photo"],
          PersonnelList:personnelList, Lat:lat, Lng:lng
        };
      });
      refreshUI();
      hideLoading();
    }
  });
}

function refreshUI(){
  fillFilter("stationFilter", [...new Set(allData.map(d=>d.Station))]);
  fillFilter("shiftFilter", [...new Set(allData.map(d=>d.Shift))]);
  fillFilter("typeFilter", [...new Set(allData.map(d=>d.DeploymentType))]);
  renderTable();
  renderMap();
  applyHighlighting();
}

function fillFilter(id, values){
  const sel = document.getElementById(id);
  const current = sel.value;
  sel.innerHTML = '<option value="">All</option>';
  values.forEach(v=>{ if(v) sel.innerHTML += `<option value="${v}">${v}</option>`; });
  if([...sel.options].some(o=>o.value===current)) sel.value=current;
}

function getFilteredData(){
  const sf=document.getElementById("stationFilter").value;
  const sh=document.getElementById("shiftFilter").value;
  const tf=document.getElementById("typeFilter").value;
  return allData.filter(d=>
    (!sf || d.Station===sf) && (!sh || d.Shift===sh) && (!tf || d.DeploymentType===tf)
  );
}

function renderTable(){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  getFilteredData().forEach((d, idx)=>{
    const tr=document.createElement("tr");
    const personnelHTML = d.PersonnelList.map(
      (p)=>`<span onclick="focusMarker(${idx})">${p.name}</span>`
    ).join("<br>");
    tr.innerHTML=`
      <td>${d.Station||""}</td>
      <td>${d.Shift||""}</td>
      <td>${d.DeploymentType||""}</td>
      <td>${d.CallSign||""}</td>
      <td class="personnel">${personnelHTML}</td>
      <td>${d.Communication||""}</td>
      <td>${d.Location||""}</td>
      <td>${d.Photo ? `<img src="${d.Photo}" width="50">` : ""}</td>
    `;
    tr.addEventListener("click", ()=>toggleHighlight(idx));
    tbody.appendChild(tr);
  });
}

function renderMap(){
  markers.forEach(m=>{ if(m) map.removeLayer(m); });
  markers=[];
  getFilteredData().forEach((d, idx)=>{
    if(d.Lat && d.Lng){
      const marker=L.marker([d.Lat,d.Lng]).addTo(map);
      marker.bindPopup(`
        <b>${d.Station}</b><br>
        Shift: ${d.Shift}<br>
        Type: ${d.DeploymentType}<br>
        Call Sign: ${d.CallSign}<br>
        Personnel: ${d.PersonnelList.map(p=>p.name).join(", ")}<br>
        Comm: ${d.Communication}<br>
        Location: ${d.Location}<br>
        ${d.Photo ? `<img src="${d.Photo}" width="100">` : ""}
      `);
      marker.on("click", ()=>toggleHighlight(idx));
      markers.push(marker);
    } else { markers.push(null); }
  });
}

function focusMarker(idx){
  const d = getFilteredData()[idx];
  if(d && d.Lat && d.Lng){
    map.setView([d.Lat, d.Lng], 15, {animate:true});
    if(markers[idx]) markers[idx].openPopup();
    toggleHighlight(idx);
  }
}

function toggleHighlight(idx){
  if(selectedIdx===idx){ selectedIdx=null; }
  else { selectedIdx=idx; }
  applyHighlighting();
}

function applyHighlighting(){
  const rows=[...document.querySelectorAll("#dataTable tbody tr")];
  rows.forEach((row,i)=>{
    if(selectedIdx===null){ row.classList.remove("dimmed","highlighted"); }
    else if(i===selectedIdx){ row.classList.add("highlighted"); row.classList.remove("dimmed"); }
    else { row.classList.add("dimmed"); row.classList.remove("highlighted"); }
  });
  markers.forEach((m,i)=>{
    if(m){
      const el=m._icon;
      if(!el) return;
      el.classList.remove("dimmed","highlighted");
      if(selectedIdx===null) return;
      if(i===selectedIdx){ el.classList.add("highlighted"); }
      else { el.classList.add("dimmed"); }
    }
  });
}

document.getElementById("stationFilter").addEventListener("change", ()=>{renderTable();renderMap();applyHighlighting();});
document.getElementById("shiftFilter").addEventListener("change", ()=>{renderTable();renderMap();applyHighlighting();});
document.getElementById("typeFilter").addEventListener("change", ()=>{renderTable();renderMap();applyHighlighting();});

initMap();
loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
