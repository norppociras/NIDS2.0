<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Law Enforcement Deployment Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #container { display:flex; height:100vh; }
    #sidebar { width:40%; overflow:auto; padding:10px; background:#f9f9f9; }
    #map { flex:1; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #ccc; padding:5px; font-size:12px; text-align:left; }
    th { background:#eee; }
    td.personnel span { cursor:pointer; color:blue; text-decoration:underline; }
    .loading { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#fff; padding:5px 10px; border:1px solid #ccc; }
  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <h2>Deployment Data</h2>
    <div id="loading" class="loading" style="display:none;">Loading...</div>
    <div>
      <label>Filter by Station:</label>
      <select id="stationFilter"><option value="">All</option></select>
    </div>
    <div>
      <label>Filter by Shift:</label>
      <select id="shiftFilter"><option value="">All</option></select>
    </div>
    <div>
      <label>Filter by Deployment Type:</label>
      <select id="typeFilter"><option value="">All</option></select>
    </div>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Station</th>
          <th>Shift</th>
          <th>Type</th>
          <th>Call Sign</th>
          <th>Personnel</th>
          <th>Comm</th>
          <th>Location</th>
          <th>Photo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="map"></div>
</div>

<script>
const baseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLRdvUF4Q7leQXDAZ6fG-e9RTBBqy9eutZ6V70RJLpV6_ForYuRKgfQ24KJVy7MqZkiqn9sRbLTYtL/pub?output=csv";

let map, markers = [], allData = [];

function showLoading(){ document.getElementById("loading").style.display="block"; }
function hideLoading(){ document.getElementById("loading").style.display="none"; }

function initMap(){
  map = L.map("map").setView([12, 122], 6);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:"&copy; OpenStreetMap contributors"
  }).addTo(map);
}

function loadData(){
  showLoading();
  const sheetUrl = baseUrl + "&t=" + new Date().getTime();
  Papa.parse(sheetUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:res=>{
      allData = res.data.map(r=>{
        // Parse Lat/Long
        let lat=null, lng=null;
        if(r["Lat_Long"]){
          const parts = r["Lat_Long"].split(/[, ]+/);
          if(parts.length>=2){
            lat = parseFloat(parts[0]);
            lng = parseFloat(parts[1]);
          }
        }
        // Parse Personnel
        let rawPersonnel = (r["Personnel (Rank_FName_MI_LName)"] || "")
          .split(/[,;\n]+/).map(p=>p.trim()).filter(p=>p);
        let personnelList = rawPersonnel.map(p=>{
          const match = p.match(/^(.*?)\s*\((\d+)\)$/);
          if(match){
            return {name:match[1].trim(), mobile:match[2]};
          } else {
            return {name:p, mobile:""};
          }
        });
        return {
          ...r,
          Station:r["Station"],
          Shift:r["Shift"],
          DeploymentType:r["Deployment Type"],
          CallSign:r["Call Sign"],
          Communication_Capability:r["Communication Capability"],
          Location:r["Location"],
          Photo:r["Photo"],
          PersonnelList:personnelList,
          Lat:lat,
          Lng:lng
        };
      });
      refreshUI();
      hideLoading();
    }
  });
}

function refreshUI(){
  fillFilter("stationFilter", [...new Set(allData.map(d=>d.Station))]);
  fillFilter("shiftFilter", [...new Set(allData.map(d=>d.Shift))]);
  fillFilter("typeFilter", [...new Set(allData.map(d=>d.DeploymentType))]);
  renderTable();
  renderMap();
}

function fillFilter(id, values){
  const sel = document.getElementById(id);
  const current = sel.value;
  sel.innerHTML = '<option value="">All</option>';
  values.forEach(v=>{
    if(v) sel.innerHTML += `<option value="${v}">${v}</option>`;
  });
  if([...sel.options].some(o=>o.value===current)) sel.value=current;
}

function getFilteredData(){
  const sf = document.getElementById("stationFilter").value;
  const sh = document.getElementById("shiftFilter").value;
  const tf = document.getElementById("typeFilter").value;
  return allData.filter(d=>
    (!sf || d.Station===sf) &&
    (!sh || d.Shift===sh) &&
    (!tf || d.DeploymentType===tf)
  );
}

function renderTable(){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  getFilteredData().forEach((d, idx)=>{
    const tr=document.createElement("tr");
    const personnelHTML = d.PersonnelList.map((p, i)=>
      `<span onclick="focusMarker(${idx})">${p.name}</span>`
    ).join("<br>");
    tr.innerHTML=`
      <td>${d.Station}</td>
      <td>${d.Shift}</td>
      <td>${d.DeploymentType}</td>
      <td>${d.CallSign}</td>
      <td class="personnel">${personnelHTML}</td>
      <td>${d.Communication_Capability}</td>
      <td>${d.Location}</td>
      <td>${d.Photo ? `<img src="${d.Photo}" width="50">` : ""}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderMap(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  getFilteredData().forEach((d, idx)=>{
    if(d.Lat && d.Lng){
      const marker = L.marker([d.Lat,d.Lng]).addTo(map);
      marker.bindPopup(`
        <b>${d.Station}</b><br>
        Shift: ${d.Shift}<br>
        Type: ${d.DeploymentType}<br>
        Call Sign: ${d.CallSign}<br>
        Personnel: ${d.PersonnelList.map(p=>p.name).join(", ")}<br>
        Comm: ${d.Communication_Capability}<br>
        Location: ${d.Location}<br>
        ${d.Photo ? `<img src="${d.Photo}" width="100">` : ""}
      `);
      markers.push(marker);
    } else {
      markers.push(null);
    }
  });
}

function focusMarker(idx){
  const d = getFilteredData()[idx];
  if(d && d.Lat && d.Lng){
    map.setView([d.Lat, d.Lng], 15, {animate:true});
    if(markers[idx]) markers[idx].openPopup();
  }
}

// Event listeners
document.getElementById("stationFilter").addEventListener("change", ()=>{renderTable();renderMap();});
document.getElementById("shiftFilter").addEventListener("change", ()=>{renderTable();renderMap();});
document.getElementById("typeFilter").addEventListener("change", ()=>{renderTable();renderMap();});

initMap();
loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
