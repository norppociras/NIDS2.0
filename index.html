<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NIDS 2.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#121212; --panel:#1f1f1f; --muted:#777; --accent:#00bfff; --gold:#ffcc00; --card:#222;}
    html,body{height:100%;margin:0;background:var(--bg);color:#eee;font-family:Inter,Arial,Helvetica,sans-serif}
    .app{display:flex;height:100vh}
    .sidebar {width: 25%; padding: 16px;  background: var(--panel);  box-sizing: border-box;  overflow-y: scroll;  scrollbar-width: none;}
    .sidebar::-webkit-scrollbar {display: none;}
    h1{margin:0 0 10px 0;color:var(--gold);font-size:16px}
    h2{margin:0 0 10px 0;color:var(--gold);font-size:12px}
    label{display:block;font-size:13px;color:#ddd;margin:10px 0 6px}
    select{width:100%;padding:8px;border-radius:6px;background:#2b2b2b;border:1px solid #333;color:#fff}
    button{margin-top:12px;padding:6px 12px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:6px;border:1px solid #2a2a2a;font-size:12px}
    th{background:#2a2a2a;color:var(--gold);text-align:left}
    .crime-row{cursor:pointer}
    .crime-row.selected{background:var(--gold);color:#111;font-weight:700}
    .crime-row.muted{opacity:0.3}
    .person-row{cursor:pointer}
    .person-row.muted{opacity:0.45}
    #personnelTable td, #personnelTable th{font-size:11px;}
	#crimeTable td, #personnelTable th{font-size:11px;}
    .main{flex:1;display:flex;flex-direction:column;padding:10px;box-sizing:border-box}
    #map{flex:1;border-radius:6px;overflow:hidden;position:relative}
    #loadingOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
      background: rgba(0,0,0,0.6); z-index:9999;pointer-events:none;opacity:0;transition:opacity .28s;}
    #loadingOverlay.active{pointer-events:all;opacity:1}
    .spinner{width:48px;height:48px;border-radius:50%;border:6px solid #222;border-top-color:var(--gold);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #summaryBox{
      position:absolute; bottom:12px; left:12px;
      background:black; color:yellow;
      padding:4px 6px; border-radius:4px;
      font-size:10px; font-weight:500;
      z-index:500; opacity:0.85;
    }
    #summaryBox table{border-collapse:collapse;}
    #summaryBox td{padding:2px 6px; border:1px solid #555; font-size:10px;}

    /* Smooth expandable personnel table */
    .table-container {
      max-height: 120px; /* collapsed */
      overflow-y: hidden;
      border: 1px solid #333;
      border-radius: 4px;
      transition: max-height 0.3s ease;
    }
    .table-container.expanded {
      max-height: 200px; /* expanded with scroll */
      overflow-y: auto;
    }
    .table-container::-webkit-scrollbar { width: 6px; }
    .table-container::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
    .toggle-link {
      color: var(--accent);
      font-size: 12px;
      cursor: pointer;
      margin-top: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <h1>NIDS 2.0 &nbsp;&nbsp;<button id="refreshBtn">Refresh</button></h1>
      <label for="stationFilter">Station</label>
      <select id="stationFilter"><option value="All">All</option></select>
      <label for="shiftFilter">Shift</label>
      <select id="shiftFilter" disabled><option value="All">All</option></select>
      
      <h2 style="margin-top:16px">Personnel</h2>
      <div id="personnelContainer" class="table-container">
        <table id="personnelTable">
          <thead><tr><th>Name</th><th>CallSign</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <span id="togglePersonnel" class="toggle-link" style="display:none;">Show more</span>

      <h2 style="margin-top:20px">8 Focus Crimes</h2>
      <table id="crimeTable"><thead><tr><th>Crime</th><th>Barangay</th><th><center>Count</center></th></tr></thead><tbody></tbody></table>
    </div>
    <div class="main">
      <div id="map">
        <div id="summaryBox">Summary...</div>
      </div>
    </div>
  </div>
  <div id="loadingOverlay"><div class="spinner"></div></div>
  <script>
    const baseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7YRTsrzLyw7y0LbQRZUQGux3DoLchErLv2XblODrr3MqaWP70nldyTH7cMi-dvNhAjtlJyn3N6XpW/pub?output=csv";
    const FOCUS_CRIMES = ["Murder", "Homicide","Physical Injury","Rape","Robbery","Theft","Carnapping MC","Carnapping MV"];

    const ICONS = {
      "Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/footpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
      "Foot Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/footpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
      "Motorcycle Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/motorpatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
      "Mobile Patrol": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/mobilepatrol.png", iconSize:[32,32], iconAnchor:[16,32] }),
      "Checkpoint": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/checkpoint.png", iconSize:[32,32], iconAnchor:[16,32] }),
      "Stationed": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/stationed.png", iconSize:[32,32], iconAnchor:[16,32] }),
      "default": L.icon({ iconUrl: "https://pronir-norppo.github.io/NIDS2.0/icons/default.png", iconSize:[32,32], iconAnchor:[16,32] })
    };

    let allData = [], markers=[];
    let selectedStation="All", selectedShift="All", selectedCrime=null;
    let personnelExpanded=false;

    const defaultCenter = [9.3, 123.2];
    const defaultZoom = 9;

    const map = L.map('map').setView(defaultCenter, defaultZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; <b>NOPPO PICTMU</b> - OpenStreet Map' }).addTo(map);

    const stationSelect=document.getElementById("stationFilter");
    const shiftSelect=document.getElementById("shiftFilter");
    const crimeTbody=document.querySelector("#crimeTable tbody");
    const personnelTbody=document.querySelector("#personnelTable tbody");
    const loadingOverlay=document.getElementById("loadingOverlay");
    const summaryBox=document.getElementById("summaryBox");
    const personnelContainer=document.getElementById("personnelContainer");
    const toggleLink=document.getElementById("togglePersonnel");

    function showLoading(){loadingOverlay.classList.add("active");}
    function hideLoading(){setTimeout(()=>loadingOverlay.classList.remove("active"),200);}

    function toE164(num) {
      if (!num) return null;
      const digits = String(num).replace(/\D/g, '');
      if (!digits) return null;
      let d = digits;
      if (d.startsWith('0')) d = '63' + d.slice(1);
      else if (d.startsWith('9')) d = '63' + d;
      else if (d.startsWith('63')) d = d;
      return '+' + d;
    }

    function toViberURI(num) {
      const e = toE164(num);
      return e ? `viber://chat?number=${e}` : '';
    }

    function loadData(){
      showLoading();
      const sheetUrl = baseUrl + "&t=" + new Date().getTime();
      Papa.parse(sheetUrl,{download:true,header:true,skipEmptyLines:true,
        complete:res=>{
          allData=res.data.map(r=>{
            let rawPersonnel = (r.Personnel || "").split(/[,;\n]+/).map(p => p.trim()).filter(p => p);
            let personnelList = rawPersonnel.map(p => {
              const match = p.match(/^(.*?)\s*\((\d+)\)$/);
              if (match) {
                return { name: match[1].trim(), mobile: match[2] };
              } else {
                return { name: p, mobile: "" };
              }
            });
            return {...r, PersonnelList: personnelList, Lat:+r.Lat, Lng:+r.Lng};
          });
          refreshUI();hideLoading();
        }
      });
    }

    function refreshUI(){
      markers.forEach(m=>map.removeLayer(m));markers=[];

      allData.forEach(r=>{
        const icon=ICONS[r.DeploymentType]||ICONS.default;
        const m=L.marker([r.Lat,r.Lng],{icon}).addTo(map);
        m.row = r;

        let nameListHtml = r.PersonnelList.map((p, i) => {
          let viber = p.mobile ? `<a href="${toViberURI(p.mobile)}" target="_blank">${p.mobile}</a>` : "";
          return `&nbsp;&nbsp;&nbsp;${i+1}. ${p.name}${viber ? ` (${viber})` : ""}`;
        }).join("<br>");

        m.bindPopup(
          `<b>Unit:</b> ${r.Station}<br>
           <b>Name:</b><br>${nameListHtml}<br><br>
           <b>Call Sign:</b> ${r.CallSign}<br>
		   <b>Communication:</b> ${r.Communication_Capability}<br>
           <b>Shift:</b> ${r.Shift}<br>
           <b>Patrol Area:</b> ${r.Location}`
        );
        markers.push(m);
      });

      const stationList = [...new Set(allData.map(d => d.Station))].sort((a,b) => a.localeCompare(b));
populateDropdown(stationSelect, ["All", ...stationList], selectedStation);

      shiftSelect.innerHTML='<option value="All">All</option>';
      shiftSelect.disabled=true;

      applyFilters();
    }

    function populateDropdown(el,vals,preserved){
      el.innerHTML="";
      vals.forEach(v=>{
        const o=document.createElement("option");
        o.value=v;
        o.textContent=v;
        el.appendChild(o);
      });
      el.value=vals.includes(preserved)?preserved:"All";
    }

    function applyFilters(){
      showLoading();
      const data=allData.filter(d=>(stationSelect.value==="All"||d.Station===stationSelect.value)&&(shiftSelect.value==="All"||d.Shift===shiftSelect.value));
      renderCrimeTable(data);
      let filtered=data;if(selectedCrime)filtered=data.filter(d=>d.CrimeFocus===selectedCrime);
      renderPersonnelTable(filtered);
      updateMarkerOpacity(filtered);
      updateSummaryBox(filtered);
      hideLoading();
    }

    function renderCrimeTable(data){
      crimeTbody.innerHTML = "";

      if(stationSelect.value === "All"){
        const counts = {};
        data.forEach(d => {
          if(d.CrimeFocus){
            counts[d.CrimeFocus] = (counts[d.CrimeFocus] || 0) + 1;
          }
        });

        FOCUS_CRIMES.forEach(c => {
          const tr = document.createElement("tr");
          tr.className = "crime-row";
          if((counts[c]||0) === 0) tr.classList.add("muted");
          tr.innerHTML = `<td>${c}</td><td>(select a station)</td><td><center>${counts[c]||0}</center></td>`;
          crimeTbody.appendChild(tr);
        });

      } else {
        const counts = {};
        data.forEach(d => {
          if(d.CrimeFocus && d.Barangay){
            const key = d.CrimeFocus + "|" + d.Barangay;
            counts[key] = (counts[key] || 0) + 1;
          }
        });

        Object.entries(counts).forEach(([key,count]) => {
          const [crime, barangay] = key.split("|");
          const tr = document.createElement("tr");
          tr.className = "crime-row";
          tr.innerHTML = `<td>${crime}</td><td>${barangay}</td><td><center>${count}</center></td>`;
          crimeTbody.appendChild(tr);
        });

        if(!crimeTbody.children.length){
          crimeTbody.innerHTML = `<tr><td colspan=3>No crimes</td></tr>`;
        }
      }
    }

    function renderPersonnelTable(rows){
      personnelTbody.innerHTML="";
      if(!rows.length){personnelTbody.innerHTML=`<tr><td colspan=3>No personnel</td></tr>`;toggleLink.style.display="none";return;}
      
      const visibleRows = personnelExpanded ? rows : rows.slice(0,5);
      visibleRows.forEach(r=>{
        const tr=document.createElement("tr");tr.className="person-row";
        let namesOnly = r.PersonnelList.map(p => p.name).join(", ");
        tr.innerHTML=`<td>${namesOnly}</td><td>${r.CallSign}</td>`;
        tr.onclick=()=>{
          const f = markers.find(m => m.row && m.row.CallSign === r.CallSign && m.row.Station === r.Station);
          if(f){
            const latlng = f.getLatLng();
            map.flyTo(latlng, 15);
            f.openPopup();
          }
        };
        personnelTbody.appendChild(tr);
      });

      if(rows.length>5){
        toggleLink.style.display="inline-block";
        toggleLink.textContent=personnelExpanded ? "Show less" : "Show more";
      } else {
        toggleLink.style.display="none";
      }

      if(personnelExpanded){personnelContainer.classList.add("expanded");}
      else{personnelContainer.classList.remove("expanded");}
    }

    function updateMarkerOpacity(rows){
      const set=new Set(rows.map(r=>r.CallSign));
      markers.forEach(m=>{
        const el=m.getElement();
        if(!el)return;
        if(set.has(m.row?.CallSign)){
          el.style.opacity=1;el.style.pointerEvents="auto";
        } else {
          if(stationSelect.value!=="All"){
            el.style.opacity=0.5;el.style.pointerEvents="none";
          } else {
            el.style.opacity=1;el.style.pointerEvents="auto";
          }
        }
      });
    }

    function updateSummaryBox(rows){
      if(!rows.length){summaryBox.innerHTML="No personnel";return;}
      let byShift={};rows.forEach(r=>{byShift[r.Shift]=(byShift[r.Shift]||0)+1;});
      let html="<table><tr><td>Total</td><td>"+rows.length+"</td></tr>";
      Object.entries(byShift).forEach(([t,c])=>{html+="<tr><td>"+t+"</td><td>"+c+"</td></tr>";});
      html+="</table>";summaryBox.innerHTML=html;
    }

    stationSelect.onchange=()=>{
      selectedStation=stationSelect.value;
      selectedCrime=null;

      if(selectedStation==="All"){
        shiftSelect.innerHTML='<option value="All">All</option>';
        shiftSelect.value="All";
        shiftSelect.disabled=true;
        selectedShift="All";
      } else {
        const availableShifts=[...new Set(allData.filter(d=>d.Station===selectedStation).map(d=>d.Shift))];
        shiftSelect.innerHTML='<option value="All">All</option>';
        availableShifts.forEach(s=>{
          const opt=document.createElement("option");
          opt.value=s;opt.textContent=s;
          shiftSelect.appendChild(opt);
        });
        shiftSelect.disabled=false;
        shiftSelect.value="All";
        selectedShift="All";
      }
      applyFilters();
    };

    shiftSelect.onchange=()=>{selectedShift=shiftSelect.value;applyFilters();};

    toggleLink.onclick=()=>{
      personnelExpanded=!personnelExpanded;
      applyFilters();
    };

    document.getElementById("refreshBtn").onclick=()=>{
      selectedStation="All";selectedShift="All";selectedCrime=null;
      stationSelect.value="All";shiftSelect.value="All";shiftSelect.disabled=true;
      map.setView(defaultCenter,defaultZoom);
      loadData();
    };

    loadData();
  </script>
</body>
</html>
